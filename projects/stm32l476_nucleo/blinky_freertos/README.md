## Use Zig after generating the project with STM32CubeMX

Details about project structure are explained in this [chapter](#Structure).
To use Zig in any microcontrollers `STM32CubeMX` generated project, follow these modification steps:

1. **Create a `build.zig` file** and configure it to compile the C source files (Use this one as a model).
2. **Update the target** based on the microcontroller you selected (e.g., line 7 in the `build.zig` file):

    ```zig
    const query: std.Target.Query = .{
        .cpu_arch = .thumb,
        .cpu_model = .{ .explicit = &std.Target.arm.cpu.cortex_m4 }, // Cortex-M4
        .cpu_features_add = std.Target.arm.featureSet(&[_]std.Target.arm.Feature{std.Target.arm.Feature.vfp4d16sp}), // Floating-point support
        .os_tag = .freestanding,
        .abi = .eabihf,
        .glibc_version = null,
    };
    ```

3. **Update the GCC target** as well (line 63). Gcc provide the libc.

    ```zig
    const gcc_arm_multidir_relative_path = std.mem.trim(u8, b.run(&.{ arm_gcc_pgm, "-mcpu=cortex-m4", "-mfpu=fpv4-sp-d16", "-mfloat-abi=hard", "-print-multi-directory" }), "\r\n");
    ```

4. **Update the linker script** (`stm32l476rgtx_flash.ld`). Some adjustments are required to make it compatible with `lld`, the linker used by Zig.

    1. Move the declaration for `_estack` to after the `RAM` region is defined.
    2. The section `_user_heap_stack` is located in RAM (and thus won’t be flashed to the device), so it should be marked with `(NOLOAD)` as shown below:

    ```ld
    ._user_heap_stack (NOLOAD) :
    {
        . = ALIGN(8);
        PROVIDE ( end = . );
        PROVIDE ( _end = . );
        . = . + _Min_Heap_Size;
        . = . + _Min_Stack_Size;
        . = ALIGN(8);
    } >RAM
    ```

5. **Create a `main.zig` file** with a custom entry point, such as `zigEntrypoint`.
6. **Call the `zigEntrypoint` function** from the `main` function located in the `Core/Src/main.c` file.

__Notes__

- To define additional macros in the `build.zig` file, such as enabling the LL driver, use `addCMacro("USE_LL_DRIVER", "");` for each module declared.

## Build

```bash
# Build
zig build
# Upload using stlink-tools
zig build flash
# Rmemove .zig-cache folder
zig build clean
```

### Options

```bash
# Enable Float formatting with newlib
zig build -DNEWLIB_PRINTF_FLOAT
# Add Custom GCCPATH
zig build -DARM_GCC_PATH=<path>
```

## Structure

```bash
blinky_freertos/
├── Core
│   ├── Inc
│   │   ├── FreeRTOSConfig.h
│   │   ├── gpio.h
│   │   ├── main.h
│   │   ├── stm32l4xx_hal_conf.h
│   │   ├── stm32l4xx_it.h
│   │   └── usart.h
│   └── Src
│       ├── freertos.c
│       ├── freertos-openocd.c
│       ├── gpio.c
│       ├── main.c
│       ├── stm32l4xx_hal_msp.c
│       ├── stm32l4xx_hal_timebase_tim.c
│       ├── stm32l4xx_it.c
│       ├── syscalls.c
│       ├── sysmem.c
│       ├── system_stm32l4xx.c
│       └── usart.c
├── Drivers
├── Middlewares
├── src
│   └── main.zig
├── .vscode
├── blinky_freertos.ioc
├── build.zig
├── .clangd
├── .clang-format
├── .clang-tidy
├── freertos-openocd.cfg
├── .gdbinit
├── Makefile
├── README.md
├── startup_stm32l476xx.s
├── stm32l476rgtx_flash.ld
└── STM32L476.svd
```

- The `Core`, `Drivers` and `Middlewares` folders were generated by STM32CubeMX software.
- **Configuration files** such as `.vscode`, `.clangd`, `.clang-format`, `.clang-tidy`, and `.editorconfig` were added for project tooling purposes.
- The file `.gdbinit` is used to debug programs that were built in a container.
- The file `STM32L476.svd` was added to enable debugging of hardware peripherals using VSCode.
- The files `freertos-openocd.cfg` and `freertos-openocd.c` are included to assist with debugging using OpenOCD, specifically for displaying information about each task.
- The files `build.zig` and `src/main.zig` are specific to Zig and are included for Zig-related functionality.


## References

- FreeRTOS discussion on [ziggit.dev](https://ziggit.dev/t/exploring-zig-on-stm32-with-freertos/4653)