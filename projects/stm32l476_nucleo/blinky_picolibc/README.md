## Description

The zig code starts at the `zig_entrypoint` function which is called from the `main` function which is located in the `Core/Src/main.c` file.  
The `Core` and `Drivers` folders were generated by `STM32CubeMX` software.

## Build

### Zig

```bash
# Build
zig build
# Upload using stlink-tools
zig build flash
# Rmemove .zig-cache folder
zig build clean
```

## Structure

```bash
blinky_picolibc/
├── Core
│   ├── Inc
│   │   ├── gpio.h
│   │   ├── main.h
│   │   ├── stm32l4xx_hal_conf.h
│   │   ├── stm32l4xx_it.h
│   │   └── usart.h
│   └── Src
│       ├── gpio.c
│       ├── main.c
│       ├── stm32l4xx_hal_msp.c
│       ├── stm32l4xx_it.c
│       ├── syscalls.c
│       ├── sysmem.c
│       ├── system_stm32l4xx.c
│       ├── usart.c
│       └── vector_table.c
├── Drivers
├── libc
│   ├── include
│   └── lib
│       ├── thumb
│       │   └── v7e-m+fp
│       │       └── hard
│       ├── picolibc.ld
│       └── picolibcpp.ld
├── src
│   └── main.zig
├── .vscode
├── blinky.ioc
├── build.zig
├── .clangd
├── .clang-format
├── .clang-tidy
├── .editorconfig
├── .gitignore
├── README.md
├── stm32l476rgtx_flash.ld
└── STM32L476.svd
```

## Picolibc Integration  

### Prerequiste

Linux

```bash
#Install needed tool (fedora)
sudo yum install meson ninja
#Install needed tool (debian)
sudo apt install meson ninja
```
Windows

- [meson](https://github.com/mesonbuild/meson/releases/tag/1.7.0)
- [ninja](https://github.com/ninja-build/ninja/releases/tag/v1.12.1)

---

### Build and installation

```bash
git clone https://github.com/picolibc/picolibc.git
cd picolibc
git checkout 1.8.8-1
mkdir build && cd build
```

```bash
#Set yout project path
PROJECT_WORKSPACE=<your absolute workspace path>

meson setup --cross-file ../scripts/cross-arm-none-eabi.txt \
    --prefix=${PROJECT_WORKSPACE}/libc \
    -Dtests=false \
    -Dpicocrt=true \
    -Dnewlib-global-atexit=true  \
    -Dnewlib-multithread=false \
    -Dmultilib=false \
    -Dmultilib-list=thumb/v7e-m+fp/hard \
    ../

ninja install
```

---

### Integrating libc with Your Zig Script

If you compile your Zig program using `elf.linkSystemLibrary("c");` or if your module has the option `.link_libc = true,`, you may encounter the following error:

```bash
error: libc not available
    note: run 'zig libc -h' to learn about libc installations
    note: run 'zig targets' to see the targets for which zig can always provide libc
```

Zig does not currently allow you to customize your own libc implementation. For more details, see this [GitHub issue](https://github.com/ziglang/zig/issues/20327) discussing the topic.
However, there is a workaround: you can rename the libc library and link it manually.

For example:
```bash
cp libc/lib/thumb/v7e-m+fp/hard/libc.a libc/lib/thumb/v7e-m+fp/hard/libc_pico.a
```

Then, change `elf.linkSystemLibrary("c");` to `elf.linkSystemLibrary("c_pico");`.

Now it is compile, however zig code will not benefit of libc implementation.

---

### Modifying the Picolibc Linker Script

Picolibc provides two linker script `picolibc.ld` and `picolibcpp.ld` that is used during the linking process. To use it with Zig's linker (`lld`), you need to change the unsupported instruction `ALIGN_WITH_INPUT`:

1. Replace section `.data`

```
	.data :  ALIGN_WITH_INPUT  {
		*(.data .data.*)
		*(.gnu.linkonce.d.*)
```

by 

```
	.data : {
        /* Align the section start .data */
        . = ALIGN(8);

		*(.data .data.*)
		*(.gnu.linkonce.d.*)
```

2.  Replace section `.tdata`

```ld
	.tdata : /* For ld.lld:  ALIGN(__tls_align) */  ALIGN_WITH_INPUT  {
```
by 

```ld
	.tdata : /* For ld.lld:  ALIGN(__tls_align) */  ALIGN(__tls_align)  {
```

I use `picolibc.ld` linker script for this program, see `stm32l476rgtx_flash.ld`


### Replace the linker script from STM32CubeMX

See the new linker script `stm32l476rgtx_flash.ld`

### Replace the startup code

From informations of `startup_stm32l476xx.s` file, I created my own startup `vector_table.c` with modification for picolibc integration


## Notes About libc

- For an interesting discussion on integrating Picolibc or alternative libc implementations for embedded systems, check out this [Ziggit thread](https://ziggit.dev/t/adding-picolibc-or-alternative-for-embedded/).
- For more context on integrating custom libc implementations, see this [GitHub issue](https://github.com/ziglang/zig/issues/20327).



