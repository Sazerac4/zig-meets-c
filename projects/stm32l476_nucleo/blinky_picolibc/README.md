## Description

The zig code starts at the `zig_entrypoint` function which is called from the `main` function which is located in the `Core/Src/main.c` file.  
The `Core` and `Drivers` folders were generated by `STM32CubeMX` software.

## Build

### Zig

```bash
# Build
zig build
# Upload using stlink-tools
zig build flash
# Rmemove .zig-cache folder
zig build clean
```

## Structure

```bash
blinky_picolibc/
├── Core
│   ├── Inc
│   │   ├── gpio.h
│   │   ├── main.h
│   │   ├── stm32l4xx_hal_conf.h
│   │   ├── stm32l4xx_it.h
│   │   └── usart.h
│   └── Src
│       ├── gpio.c
│       ├── main.c
│       ├── stm32l4xx_hal_msp.c
│       ├── stm32l4xx_it.c
│       ├── system_stm32l4xx.c
│       ├── usart.c
│       └── vector_table.c
├── Drivers
├── libc
│   ├── include
│   └── lib
│       ├── picolibc.ld
│       └── picolibcpp.ld
├── src
│   └── main.zig
├── .vscode
├── blinky.ioc
├── build.zig
├── .clangd
├── .clang-format
├── .clang-tidy
├── .editorconfig
├── .gitignore
├── README.md
├── stm32l476rgtx_flash.ld
└── STM32L476.svd
```

## Picolibc Integration  

### Prerequiste

Linux

```bash
#Install needed tool (fedora)
sudo yum install meson ninja llvm-19 clang-19 lld-19
#Install needed tool (debian)
sudo apt install meson ninja-build llvm-19 clang-19 lld-19
```
Windows

- [meson](https://github.com/mesonbuild/meson/releases/tag/1.7.0)
- [ninja](https://github.com/ninja-build/ninja/releases/tag/v1.12.1)
- [llvm19](https://github.com/llvm/llvm-project/releases/tag/llvmorg-19.1.0)

---

### Build and installation

### Build with container

```bash
# Create the image
podman build -f ContainerFile --tag=picolibc .
# Run a container
podman run --rm -it --privileged -v ./:/workspace --name=picolibc picolibc
# Configure
mkdir -p build/picolib && cd build/picolib
meson setup --cross-file /workspace/libc/cross-clang-thumbv7e+fp-none-eabi.txt \
    --prefix=/workspace/libc \
    -Dtests=false \
    -Dpicocrt=true \
    -Dnewlib-global-atexit=true  \
    -Dnewlib-retargetable-locking=true \
    -Dnewlib-multithread=true \
    -Dformat-default=minimal \
    -Ddebug=false \
    -Doptimization=s \
    /picolibc/

# Install
ninja install
# The following line is explained below
mv /workspace/libc/lib/libc.a /workspace/libc/lib/libc_pico.a
```

## Build libc with Other CPU Parameters

You need to create a Meson configuration file, such as `cross-clang-thumbv7e+fp-none-eabi.txt`, and modify these parameters according to your needs:

```
-mcpu=cortex-m4
-mfloat-abi=hard
-mfpu=fpv5-sp-d16
```

### Integrating libc with Your Zig Script

If you compile your Zig program using `elf.linkSystemLibrary("c");` or if your module has the option `.link_libc = true,`, you may encounter the following error:

```bash
error: libc not available
    note: run 'zig libc -h' to learn about libc installations
    note: run 'zig targets' to see the targets for which zig can always provide libc
```

Zig does not currently allow you to customize your own libc implementation. For more details, see this [GitHub issue](https://github.com/ziglang/zig/issues/20327) discussing the topic.
However, there is a workaround: you can rename the libc library and link it manually.

For example:
```bash
cp libc/lib/libc.a libc/lib/libc_pico.a
```

Then, change `elf.linkSystemLibrary("c");` to `elf.linkSystemLibrary("c_pico");`.

Now it is compile, however zig code will not benefit of libc implementation, only the `C` sources files.

---

### Picolibc Linker Script

Picolibc provides two linker script `picolibc.ld` and `picolibcpp.ld` that is used during the linking process. You can use it with Zig's linker (`lld`) without modification because
we have build picolibc with clang/lld.

**Adapt the linker script from STM32CubeMX**

Target linker script now can just specify flash memory option, extra section and so on. See the new linker script `stm32l476rgtx_flash.ld`

### Update the startup and the Vector Table

From informations of `startup_stm32l476xx.s` file, I created my own startup `vector_table.c` with modification for picolibc integration.
You can modify the original startup file as well if you prefer.

1. Rename `g_pfnVectors` to `__interrupt_vector`. The reference is used by picolibc
2. Replace stack start  `_estack`  by `__stack`
3. Replace the entrypoint  `Reset_Handler`  by `_start`

## Notes

- For an interesting discussion on integrating Picolibc or alternative libc implementations for embedded systems, check out this [Ziggit thread](https://ziggit.dev/t/adding-picolibc-or-alternative-for-embedded/).
- For more context on integrating custom libc implementations, see this [GitHub issue](https://github.com/ziglang/zig/issues/20327).
- Effort to make compatible Zig with meson build system. [GitHub issue](https://github.com/mesonbuild/meson/issues/12652)



